rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns a document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is a member of an organization
    function isOrgMember(orgId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/organizationMembers/$(request.auth.uid + '_' + orgId));
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }
    
    // Organizations collection
    match /organizations/{orgId} {
      allow read: if isAuthenticated() && 
        resource.data.members.hasAny([request.auth.uid]);
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.ownerId == request.auth.uid;
    }
    
    // Organization Members
    match /organizationMembers/{memberId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || 
         get(/databases/$(database)/documents/organizations/$(resource.data.organizationId)).data.ownerId == request.auth.uid);
    }
    
    // Projects collection
    match /projects/{projectId} {
      allow read: if isAuthenticated() && 
        resource.data.members.hasAny([request.auth.uid]);
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.members.hasAny([request.auth.uid]);
    }
    
    // Project Members
    match /projectMembers/{memberId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Task Statuses
    match /taskStatuses/{statusId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Tasks collection
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        (resource.data.createdBy == request.auth.uid || 
         resource.data.assignees.hasAny([request.auth.uid]));
    }
    
    // Comments collection
    match /comments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Activities collection
    match /activities/{activityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false; // Activities are immutable
    }

    // Events collection (NEW for calendar)
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      // Privacy enforcement: cannot set TitleVisible on Private category unless owner
      allow write: if request.resource.data.category != 'Private' || 
        (request.resource.data.privacy != 'TitleVisible' || 
         request.auth.uid == request.resource.data.userId);
    }

    // Milestones collection (NEW for calendar)
    match /milestones/{milestoneId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }

    // Availability collection (NEW for calendar)
    match /availability/{availId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only computed by functions
    }

    // Activity Log (NEW for calendar events)
    match /activityLog/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false; // Logs are immutable
    }
  }
}
